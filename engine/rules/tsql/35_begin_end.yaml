# ==============================================================================
# T-SQL Rule: Flatten Standalone BEGIN/END Blocks
# ==============================================================================
# Remove BEGIN/END wrappers that don't belong to IF/WHILE/TRY control structures.
# This reduces nesting depth without losing DML statements.
# ==============================================================================

name: flatten_begin_end
description: |
  Remove standalone BEGIN/END wrappers.

  Flattens BEGIN/END blocks that wrap single DML statements.
  Preserves BEGIN/END for control structures (handled by other rules).

dialect: tsql
category: wrapper
enabled: true
priority: 35  # After control flow handling

# -----------------------------------------------------------------------------
# Pattern Configuration
# -----------------------------------------------------------------------------
pattern_type: regex
pattern: '\n\s*BEGIN\s*\n\s*((?:INSERT|UPDATE|DELETE|MERGE|SELECT|WITH)[\s\S]*?)\n\s*END\s*;?'
replacement: '\n\1\n'

# -----------------------------------------------------------------------------
# Test Cases
# -----------------------------------------------------------------------------
test_cases:
  - name: insert_in_begin
    description: "Remove BEGIN/END around INSERT"
    input: |

      BEGIN
          INSERT INTO Target SELECT * FROM Source
      END
    expected: |

          INSERT INTO Target SELECT * FROM Source

  - name: update_in_begin
    description: "Remove BEGIN/END around UPDATE"
    input: |

      BEGIN
          UPDATE Table1 SET X = 1
      END;
    expected: |

          UPDATE Table1 SET X = 1

# -----------------------------------------------------------------------------
# Debug Configuration
# -----------------------------------------------------------------------------
debug:
  log_matches: true
  log_replacements: true
  show_context_lines: 2

# -----------------------------------------------------------------------------
# Metadata
# -----------------------------------------------------------------------------
metadata:
  author: vibecoding
  created: "2025-11-19"
  migrated_from: "sql_cleaning_rules.py::flatten_simple_begin_end"
  tested_with: "349 stored procedures"
  affects_lineage: false
  impact: |
    Reduces nesting depth, makes SQL cleaner for parsing.
    Standalone BEGIN/END adds complexity without value.

# ==============================================================================
# T-SQL Rule: Extract DML from IF Blocks
# ==============================================================================
# Pull INSERT/UPDATE/DELETE/MERGE statements from IF wrappers.
# This captures conditional lineage even when condition might not be met at runtime.
# ==============================================================================

name: extract_if_block_dml
description: |
  Extract DML from simple IF blocks.

  Pulls DML statements from IF wrappers to capture conditional lineage.
  We want lineage regardless of runtime condition evaluation.

dialect: tsql
category: extraction
enabled: true
priority: 38  # After BEGIN/END flattening

# -----------------------------------------------------------------------------
# Pattern Configuration
# -----------------------------------------------------------------------------
pattern_type: regex
pattern: 'IF\s+[^B]+?\s+BEGIN\s+(INSERT|UPDATE|DELETE|MERGE)\s+([^;]+?)\s*;?\s*END'
replacement: '\1 \2'

# -----------------------------------------------------------------------------
# Test Cases
# -----------------------------------------------------------------------------
test_cases:
  - name: if_insert
    description: "Extract INSERT from IF block"
    input: "IF @x = 1 BEGIN INSERT INTO T1 SELECT * FROM T2 END"
    expected: "INSERT INTO T1 SELECT * FROM T2"

  - name: if_update
    description: "Extract UPDATE from IF EXISTS block"
    input: "IF EXISTS (SELECT 1) BEGIN UPDATE Table SET X = 1 END"
    expected: "UPDATE Table SET X = 1"

# -----------------------------------------------------------------------------
# Debug Configuration
# -----------------------------------------------------------------------------
debug:
  log_matches: true
  log_replacements: true
  show_context_lines: 1

# -----------------------------------------------------------------------------
# Metadata
# -----------------------------------------------------------------------------
metadata:
  author: vibecoding
  created: "2025-11-19"
  migrated_from: "sql_cleaning_rules.py::extract_if_block_dml"
  tested_with: "349 stored procedures"
  affects_lineage: true
  impact: |
    Captures conditional lineage - we want to know about data dependencies
    regardless of whether the IF condition is true at runtime.

# ==============================================================================
# T-SQL Rule: Remove SET Variable Statements (MULTI-STEP)
# ==============================================================================
# SET is used for variable assignments and session options in T-SQL.
# We remove these since variables don't affect table dependencies.
#
# Multi-step approach handles different SET patterns:
# Step 1: Remove session SET statements (NOCOUNT, ANSI_NULLS, etc.)
# Step 2: Remove SET with SELECT...FROM (admin queries)
# Step 3: Remove simple SET without SELECT (pure assignments)
# ==============================================================================

name: remove_set
description: |
  Remove SET variable assignments and session options.

  Step 1: Remove session SET statements (SET NOCOUNT ON, etc.)
  Step 2: Remove SET with SELECT...FROM (admin queries accessing tables)
  Step 3: Remove simple SET assignments (SET @var = value)

  Preserves SET with scalar SELECT (no FROM clause) - these are calculations.

dialect: tsql
category: variable_decl
enabled: true
priority: 21

# -----------------------------------------------------------------------------
# Pattern Configuration (MULTI-STEP)
# -----------------------------------------------------------------------------
pattern_type: regex

# Multiple patterns run sequentially
pattern:
  # Step 1: Remove session SET statements
  - 'SET\s+(NOCOUNT|ANSI_NULLS|QUOTED_IDENTIFIER|XACT_ABORT|ANSI_WARNINGS|ARITHABORT)\s+(ON|OFF)\s*(?:;|\n|$)'

  # Step 2: Remove SET with SELECT...FROM (admin queries)
  - 'SET\s+@\w+\s*=\s*\([^()]*SELECT[^()]*FROM[^()]*\)'

  # Step 3: Remove simple SET without SELECT (pure assignments)
  - 'SET\s+@\w+(?!\s*=\s*\([^()]*SELECT)\s*=.*?(?:;|\n|$)'

# Corresponding replacements for each step
replacement:
  - ''  # Step 1: remove session options
  - ''  # Step 2: remove admin queries
  - ''  # Step 3: remove simple assignments

# -----------------------------------------------------------------------------
# Test Cases
# -----------------------------------------------------------------------------
test_cases:
  - name: session_option
    description: "Remove SET NOCOUNT ON"
    input: |
      SET NOCOUNT ON;
      SELECT * FROM Table1
    expected: |

      SELECT * FROM Table1

  - name: simple_assignment
    description: "Remove SET @var = 'value'"
    input: |
      SET @var = 'test';
      SELECT * FROM Table1
    expected: |

      SELECT * FROM Table1

  - name: select_from_assignment
    description: "Remove SET with SELECT...FROM"
    input: |
      SET @count = (SELECT COUNT(*) FROM Table1);
      INSERT INTO Table2 SELECT * FROM Table1
    expected: |

      INSERT INTO Table2 SELECT * FROM Table1

# -----------------------------------------------------------------------------
# Debug Configuration
# -----------------------------------------------------------------------------
debug:
  log_matches: true
  log_replacements: true
  show_context_lines: 2

# -----------------------------------------------------------------------------
# Metadata
# -----------------------------------------------------------------------------
metadata:
  author: vibecoding
  created: "2025-11-19"
  migrated_from: "sql_cleaning_rules.py::remove_set_statements"
  rule_type: "multi-step"
  tested_with: "349 stored procedures"
  affects_lineage: false
  impact: |
    Removes administrative SET statements and variable assignments.
    Preserves SET with scalar SELECT functions (calculations without tables).

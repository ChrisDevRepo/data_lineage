# =============================================================================
# T-SQL Rule: Remove RAISERROR Statements
# =============================================================================
# RAISERROR is used for error handling and logging in T-SQL, but doesn't
# affect data lineage. Removing these statements reduces noise in the
# lineage graph and improves SQLGlot parsing success.
# =============================================================================

name: remove_raiserror
description: |
  Remove T-SQL RAISERROR statements that don't affect data lineage.
  RAISERROR is used for error handling and user notifications, not for
  data transformation or table access.

dialect: tsql
category: noise_reduction
enabled: true
priority: 10

# -----------------------------------------------------------------------------
# Pattern Configuration
# -----------------------------------------------------------------------------
pattern_type: regex

# Match RAISERROR statements with optional WITH clause
# Handles multi-line statements and nested parentheses
pattern: |
  RAISERROR\s*\(
    (?:[^()]|\((?:[^()]|\([^()]*\))*\))*
  \)
  (?:\s*WITH\s+[A-Z]+)?

replacement: ""

# -----------------------------------------------------------------------------
# Test Cases
# -----------------------------------------------------------------------------
test_cases:
  - name: simple_raiserror
    description: "Basic RAISERROR with string literal"
    input: "RAISERROR('Error occurred', 16, 1)"
    expected: ""

  - name: raiserror_with_variables
    description: "RAISERROR with variable parameters"
    input: "RAISERROR(@error_msg, @severity, @state)"
    expected: ""

  - name: raiserror_with_nowait
    description: "RAISERROR with WITH NOWAIT clause"
    input: "RAISERROR('Processing...', 0, 1) WITH NOWAIT"
    expected: ""

  - name: raiserror_multiline
    description: "Multi-line RAISERROR statement"
    input: |
      RAISERROR(
        'Long error message here',
        16,
        1
      )
    expected: ""

  - name: raiserror_with_formatting
    description: "RAISERROR with printf-style formatting"
    input: "RAISERROR('Error code: %d, message: %s', 16, 1, @code, @msg)"
    expected: ""

  - name: preserve_surrounding_code
    description: "Should only remove RAISERROR, preserve other statements"
    input: |
      INSERT INTO logs VALUES ('start')
      RAISERROR('Processing', 0, 1)
      SELECT * FROM table
    expected: |
      INSERT INTO logs VALUES ('start')

      SELECT * FROM table

  - name: multiple_raiserrors
    description: "Remove multiple RAISERROR statements"
    input: |
      RAISERROR('Step 1', 0, 1)
      INSERT INTO table1 VALUES (1)
      RAISERROR('Step 2', 0, 1) WITH NOWAIT
      INSERT INTO table2 VALUES (2)
    expected: |

      INSERT INTO table1 VALUES (1)

      INSERT INTO table2 VALUES (2)

# -----------------------------------------------------------------------------
# Debug Configuration
# -----------------------------------------------------------------------------
debug:
  log_matches: true
  log_replacements: true
  show_context_lines: 2

# -----------------------------------------------------------------------------
# Metadata
# -----------------------------------------------------------------------------
metadata:
  author: vibecoding
  created: "2025-11-11"
  updated: "2025-11-11"
  jira_ticket: "DL-456"
  impact: |
    Based on smoke test analysis:
    - Reduces false positives in lineage detection
    - Improves SQLGlot parsing success by removing error handling code
    - Affects approximately 327 stored procedures in production
  risk: low
  affects_lineage: false
  baseline_improvement: "+2.3% parse success rate"

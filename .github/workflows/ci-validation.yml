name: CI Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ============================================================================
  # Job 1: Backend Tests (Python)
  # ============================================================================
  backend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need history for git diff

    - name: Check if backend files changed
      id: check_backend
      run: |
        # Skip if commit message contains [skip ci]
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[skip ci\]"; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  Skipping - [skip ci] in commit message"
          exit 0
        fi

        # Always run on pull requests
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Running - pull request event"
          exit 0
        fi

        # Check if Python backend files changed
        if git diff --name-only HEAD~1 HEAD | grep -E '^(lineage_v3/|api/|tests/|requirements\.txt)'; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Backend files changed"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  No backend files changed"
        fi

    - name: Set up Python 3.10
      if: steps.check_backend.outputs.changed == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      if: steps.check_backend.outputs.changed == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run unit tests with coverage
      if: steps.check_backend.outputs.changed == 'true'
      run: |
        echo "üß™ Running unit tests..."
        pytest tests/unit -v --cov=lineage_v3 --cov=api --cov-report=xml --cov-report=term

    - name: Run integration tests
      if: steps.check_backend.outputs.changed == 'true'
      run: |
        echo "üß™ Running integration tests..."
        echo ""
        echo "Note: Integration tests require DuckDB workspace database."
        echo "Tests will skip gracefully if data/lineage_workspace.duckdb not found."
        echo "This is expected in CI without real production data."
        echo ""
        pytest tests/integration -v --tb=short
        echo ""
        echo "‚ÑπÔ∏è  Integration tests validate parser expectations:"
        echo "   - 100% success rate (all SPs have dependencies)"
        echo "   - 80%+ SPs with perfect confidence (100)"
        echo "   - Valid confidence distribution (0, 75, 85, 100)"
        echo "   - Phantom detection working correctly"

    - name: Upload coverage to Codecov (optional)
      if: steps.check_backend.outputs.changed == 'true' && github.event_name == 'pull_request'
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: backend
        name: backend-coverage
      continue-on-error: true  # Don't fail if codecov is down

  # ============================================================================
  # Job 2: User-Verified Test Cases
  # ============================================================================
  user-verified-cases:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest

    - name: Check if user-verified cases exist
      id: check_cases
      run: |
        if [ -d "tests/fixtures/user_verified_cases" ] && [ -n "$(ls -A tests/fixtures/user_verified_cases/*.yaml 2>/dev/null)" ]; then
          echo "has_cases=true" >> $GITHUB_OUTPUT
          echo "‚úÖ User-verified test cases found"
        else
          echo "has_cases=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  No user-verified test cases found (this is OK for new projects)"
        fi

    - name: Run user-verified test cases
      if: steps.check_cases.outputs.has_cases == 'true'
      run: |
        pytest tests/unit/test_user_verified_cases.py -v --tb=short

  # ============================================================================
  # Job 3: Parser Baseline Validation (Only if parser files changed)
  # ============================================================================
  parser-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comparison

    - name: Check if parser files changed
      id: check_parser
      run: |
        # Check if any parser-related files were modified
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '(quality_aware_parser.py|sql_cleaning_rules.py|simplified_rule_engine.py|rules/.*\.yaml)'; then
          echo "parser_changed=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Parser files changed - baseline validation required"
        else
          echo "parser_changed=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Parser files unchanged - skipping baseline validation"
        fi

    - name: Set up Python 3.10
      if: steps.check_parser.outputs.parser_changed == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      if: steps.check_parser.outputs.parser_changed == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run baseline validation
      if: steps.check_parser.outputs.parser_changed == 'true'
      run: |
        # Create baseline directory
        mkdir -p tests/baselines

        # Capture current baseline
        echo "üìä Capturing current parsing baseline..."
        python scripts/testing/check_parsing_results.py > tests/baselines/ci_current.txt

        # For PRs, compare with main branch
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "üìä Comparing with main branch baseline..."
          git checkout origin/main
          python scripts/testing/check_parsing_results.py > tests/baselines/ci_main.txt

          # Show diff
          echo "=== Baseline Comparison ==="
          diff tests/baselines/ci_main.txt tests/baselines/ci_current.txt || true

          # Check for critical regressions
          CURRENT_SUCCESS=$(grep -oP '\d+/\d+' tests/baselines/ci_current.txt | head -1 | cut -d'/' -f1)
          MAIN_SUCCESS=$(grep -oP '\d+/\d+' tests/baselines/ci_main.txt | head -1 | cut -d'/' -f1)

          if [ "$CURRENT_SUCCESS" -lt "$MAIN_SUCCESS" ]; then
            echo "‚ùå REGRESSION: Success rate decreased from $MAIN_SUCCESS to $CURRENT_SUCCESS"
            exit 1
          else
            echo "‚úÖ No regression detected (Success: $CURRENT_SUCCESS, Main: $MAIN_SUCCESS)"
          fi
        else
          echo "‚úÖ Baseline captured for branch push"
        fi

  # ============================================================================
  # Job 4: Frontend Tests & Linting
  # ============================================================================
  frontend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need history for git diff

    - name: Check if frontend files changed
      id: check_frontend
      run: |
        # Skip if commit message contains [skip ci]
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[skip ci\]"; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  Skipping - [skip ci] in commit message"
          exit 0
        fi

        # Always run on pull requests
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Running - pull request event"
          exit 0
        fi

        # Check if frontend files changed
        if git diff --name-only HEAD~1 HEAD | grep -E '^frontend/'; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Frontend files changed"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  No frontend files changed"
        fi

    - name: Set up Node.js
      if: steps.check_frontend.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      if: steps.check_frontend.outputs.changed == 'true'
      run: |
        cd frontend
        npm ci

    - name: Type check
      if: steps.check_frontend.outputs.changed == 'true'
      run: |
        cd frontend
        npm run type-check

    - name: Run unit tests (if configured)
      if: steps.check_frontend.outputs.changed == 'true'
      run: |
        cd frontend
        # npm test -- --run (once Vitest is set up)
        echo "‚ö†Ô∏è  Frontend unit tests not yet configured"

  # ============================================================================
  # Job 5: Frontend E2E Tests (Playwright)
  # ============================================================================
  frontend-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need history for git diff

    - name: Check if frontend files changed
      id: check_frontend_e2e
      run: |
        # Skip if commit message contains [skip ci]
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[skip ci\]"; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  Skipping - [skip ci] in commit message"
          exit 0
        fi

        # Always run on pull requests
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Running - pull request event"
          exit 0
        fi

        # Check if frontend files changed
        if git diff --name-only HEAD~1 HEAD | grep -E '^frontend/'; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Frontend files changed"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  No frontend files changed"
        fi

    - name: Set up Node.js
      if: steps.check_frontend_e2e.outputs.changed == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      if: steps.check_frontend_e2e.outputs.changed == 'true'
      run: |
        cd frontend
        npm ci

    - name: Install Playwright browsers
      if: steps.check_frontend_e2e.outputs.changed == 'true'
      run: |
        cd frontend
        npx playwright install --with-deps chromium

    - name: Build frontend
      if: steps.check_frontend_e2e.outputs.changed == 'true'
      run: |
        cd frontend
        npm run build

    - name: Run E2E tests
      if: steps.check_frontend_e2e.outputs.changed == 'true'
      run: |
        cd frontend
        npm run test:e2e -- --project=chromium

    - name: Upload test results
      if: steps.check_frontend_e2e.outputs.changed == 'true' && failure()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 7

  # ============================================================================
  # Job 6: Code Quality Checks
  # ============================================================================
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install quality tools
      run: |
        pip install ruff mypy

    - name: Run Ruff (linting)
      run: |
        ruff check lineage_v3/ api/ scripts/ --output-format=github
      continue-on-error: true  # Don't fail build, just report

    - name: Run MyPy (type checking)
      run: |
        mypy lineage_v3/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true  # Don't fail build, just report

  # ============================================================================
  # Job 7: Documentation Validation
  # ============================================================================
  docs-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need history for git diff

    - name: Check if docs changed
      id: check_docs
      run: |
        # Skip if commit message contains [skip ci]
        if echo "${{ github.event.head_commit.message }}" | grep -q "\[skip ci\]"; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  Skipping - [skip ci] in commit message"
          exit 0
        fi

        # Always run on pull requests
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Running - pull request event"
          exit 0
        fi

        # Check if docs files changed
        if git diff --name-only HEAD~1 HEAD | grep -E '^docs/'; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Docs files changed"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è  No docs files changed"
        fi

    - name: Check for outdated phantom config references
      if: steps.check_docs.outputs.changed == 'true'
      run: |
        echo "üîç Checking for outdated PHANTOM_INCLUDE_SCHEMAS references..."
        if grep -r "PHANTOM_INCLUDE_SCHEMAS" docs/ --include="*.md"; then
          echo "‚ùå Found outdated PHANTOM_INCLUDE_SCHEMAS references in docs!"
          echo "   Should use PHANTOM_EXTERNAL_SCHEMAS (v4.3.3)"
          exit 1
        else
          echo "‚úÖ No outdated phantom config references found"
        fi

    - name: Check for version consistency
      if: steps.check_docs.outputs.changed == 'true'
      run: |
        echo "üîç Checking version consistency in docs..."
        VERSION_REFS=$(grep -roh "v4\.[0-9]\.[0-9]" docs/ | sort | uniq)
        echo "Found version references: $VERSION_REFS"

        # Check if latest version (v4.3.3) is present
        if echo "$VERSION_REFS" | grep -q "v4.3.3"; then
          echo "‚úÖ Latest version v4.3.3 found in docs"
        else
          echo "‚ö†Ô∏è  Latest version v4.3.3 not found in all docs (this may be OK for historical references)"
        fi

  # ============================================================================
  # Summary Job (Required for PR merge)
  # ============================================================================
  ci-success:
    runs-on: ubuntu-latest
    needs: [backend-tests, user-verified-cases, parser-baseline, frontend-tests, frontend-e2e]
    if: always()

    steps:
    - name: Check all jobs
      run: |
        # Jobs can be "success" (passed) or "skipped" (no relevant files changed)
        # Both are acceptable outcomes. Only "failure" or "cancelled" should fail the build.

        echo "Job results:"
        echo "  backend-tests: ${{ needs.backend-tests.result }}"
        echo "  user-verified-cases: ${{ needs.user-verified-cases.result }}"
        echo "  parser-baseline: ${{ needs.parser-baseline.result }}"
        echo "  frontend-tests: ${{ needs.frontend-tests.result }}"
        echo "  frontend-e2e: ${{ needs.frontend-e2e.result }}"

        # Check for failures (skipped is OK)
        if [ "${{ needs.backend-tests.result }}" == "failure" ] || \
           [ "${{ needs.user-verified-cases.result }}" == "failure" ] || \
           [ "${{ needs.parser-baseline.result }}" == "failure" ] || \
           [ "${{ needs.frontend-tests.result }}" == "failure" ] || \
           [ "${{ needs.frontend-e2e.result }}" == "failure" ]; then
          echo "‚ùå One or more required jobs failed"
          exit 1
        fi
        echo "‚úÖ All CI checks passed (some may have been skipped)!"
